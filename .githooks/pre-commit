#!/bin/sh

# Pre-commit hook for Commatix (WSL/Docker environment)
# Runs code quality checks before allowing commit

# Get list of staged PHP files
STAGED_PHP_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep -E '\.php$')

# Exit if no PHP files staged
if [ -z "$STAGED_PHP_FILES" ]; then
    echo "‚úì No PHP files staged. Skipping PHP checks."
    exit 0
fi

echo "üîç Running pre-commit checks..."

# 1. Run Pint on staged files only
echo "  ‚Üí Running Pint (Laravel code style fixer)..."
docker exec commatix-laravel.test-1 ./vendor/bin/pint --test $STAGED_PHP_FILES
PINT_EXIT_CODE=$?
if [ $PINT_EXIT_CODE -ne 0 ]; then
    echo "‚ùå Pint found style errors! Run 'docker exec commatix-laravel.test-1 ./vendor/bin/pint' to fix them."
    exit 1
fi

# 2. Run PHPCS on staged files only
echo "  ‚Üí Running PHP Code Sniffer (PSR-12 checks)..."
docker exec commatix-laravel.test-1 ./vendor/bin/phpcs --standard=PSR12 $STAGED_PHP_FILES
PHPCS_EXIT_CODE=$?
if [ $PHPCS_EXIT_CODE -ne 0 ]; then
    echo "‚ùå PHPCS found style violations! Run 'docker exec commatix-laravel.test-1 ./vendor/bin/phpcbf' to fix fixable issues."
    exit 1
fi

# 3. Run GrumPHP for other checks (PHPStan, PHPCPD, PHPUnit, etc.)
echo "  ‚Üí Running GrumPHP for comprehensive checks..."
docker exec commatix-laravel.test-1 ./vendor/bin/grumphp run
GRUMPHP_EXIT_CODE=$?
if [ $GRUMPHP_EXIT_CODE -ne 0 ]; then
    echo "‚ùå GrumPHP checks failed! See output above."
    exit 1
fi

echo "‚úÖ All checks passed! Proceeding with commit."
exit 0
